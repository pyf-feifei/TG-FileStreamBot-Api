# Telegram代理配置说明

## 概述

**TG-FileStreamBot** 现已支持通过 **SOCKS5 代理** 连接到 Telegram 服务器。这对于在受限网络环境中开发和测试非常有用。

## 为什么需要代理支持？

在中国大陆或其他网络受限的环境中，直接连接 Telegram API 服务器可能会失败。代理支持允许您：

1. ✅ **在开发环境中完整测试上传功能**
2. ✅ **确保代码在部署前经过充分验证**
3. ✅ **避免"测试未通过就部署"的风险**

## 配置方法

### 1. 环境变量配置

在 `fsb.env` 文件中添加以下配置：

```env
# ===== 代理配置 (用于开发环境下连接Telegram) =====
# 代理地址（支持SOCKS5），格式：socks5://127.0.0.1:1080
# 留空则不使用代理
TELEGRAM_PROXY=socks5://127.0.0.1:1080
```

### 2. 支持的代理格式

#### 无认证的SOCKS5代理

```env
TELEGRAM_PROXY=socks5://127.0.0.1:1080
```

#### 带用户名密码认证的SOCKS5代理

```env
TELEGRAM_PROXY=socks5://username:password@127.0.0.1:1080
```

#### 不使用代理

```env
TELEGRAM_PROXY=
```

或直接删除/注释掉该行。

## 技术实现细节

### 实现原理

本项目通过以下方式实现 Telegram MTProto 连接的代理支持：

1. **自定义 Dialer**: 使用 `golang.org/x/net/proxy` 包创建 SOCKS5 dialer
2. **自定义 Resolver**: 使用 `gotd/td` 的 `dcs.Plain()` 配置自定义网络拨号器
3. **透明集成**: 通过 `gotgproto.ClientOpts` 的 `Resolver` 字段注入自定义连接方式

### 关键代码位置

- **配置定义**: `config/config.go` - `TelegramProxy` 字段
- **代理工具**: `internal/utils/proxy.go` - `CreateSOCKS5Dialer()` 函数
- **客户端集成**: `internal/bot/client.go` - `StartClient()` 函数

### 代码架构

```go
// 1. 创建SOCKS5 Dialer
dialFunc, err := utils.CreateSOCKS5Dialer(config.ValueOf.TelegramProxy)

// 2. 使用自定义Dialer创建Resolver
resolver := dcs.Plain(dcs.PlainOptions{
    Dial: dcs.DialFunc(dialFunc),
})

// 3. 传递给gotgproto客户端
client, err := gotgproto.NewClient(
    appID, apiHash, clientType,
    &gotgproto.ClientOpts{
        Resolver: resolver, // 使用自定义Resolver
    },
)
```

## 使用示例

### 场景 1: 使用本地 Clash 代理

如果您使用 Clash for Windows 或类似工具，默认端口通常是 `7890`：

```env
# Clash 默认端口
TELEGRAM_PROXY=socks5://127.0.0.1:7890
```

### 场景 2: 使用 V2Ray/Xray

假设您的 V2Ray SOCKS5 端口配置为 `1080`：

```env
TELEGRAM_PROXY=socks5://127.0.0.1:1080
```

### 场景 3: 远程代理服务器

```env
TELEGRAM_PROXY=socks5://myuser:mypass@proxy.example.com:1080
```

## 验证配置

### 启动服务并查看日志

```bash
.\fsb.exe run --dev
```

如果代理配置正确，您将看到类似以下的日志：

```
INFO    Using Telegram proxy    {"proxy": "socks5://127.0.0.1:7890"}
INFO    ✓ SOCKS5代理已配置       {"proxy": "socks5://127.0.0.1:7890"}
INFO    Client started  {"username": "your_bot_username"}
INFO    ✅ Telegram客户端已连接
```

### 常见错误

#### 错误 1: 代理连接超时

```
ERROR   Failed to start main bot   {"error": "context deadline exceeded"}
```

**解决方案**:
- 检查代理服务是否运行
- 验证代理端口是否正确
- 确认防火墙未阻止连接

#### 错误 2: 代理认证失败

```
ERROR   Failed to create SOCKS5 dialer  {"error": "authentication failed"}
```

**解决方案**:
- 检查用户名和密码是否正确
- 确认代理服务器是否要求认证

#### 错误 3: 无效的代理URL格式

```
ERROR   Invalid Telegram proxy configuration    {"error": "unsupported proxy scheme: http"}
```

**解决方案**:
- 仅支持 `socks5://` 格式
- 不支持 HTTP/HTTPS 代理（Telegram MTProto 需要 SOCKS5）

## 性能考虑

### 连接超时设置

代理连接的超时时间设置为 **10秒**。如果您的代理响应较慢，可以修改 `internal/bot/client.go` 中的超时值：

```go
ctx, cancel := context.WithTimeout(context.Background(), 10*time.Second)
```

### 代理稳定性

- 建议使用本地代理（如 Clash/V2Ray）而非远程代理，以减少延迟
- 代理服务的稳定性直接影响 Telegram 连接质量

## 常见问题 (FAQ)

### Q1: 为什么只支持SOCKS5，不支持HTTP代理？

**A**: Telegram 使用 MTProto 协议，该协议需要建立 TCP 连接。SOCKS5 代理可以透明地转发 TCP 流量，而 HTTP 代理主要用于 HTTP/HTTPS 流量。`gotd/td` 库本身也是基于 SOCKS5 实现代理支持。

### Q2: 生产环境需要配置代理吗？

**A**: 通常不需要。生产环境（如部署在海外服务器）可以直连 Telegram。此代理功能主要用于：
- 中国大陆的开发环境
- 网络受限的测试环境

### Q3: 代理会影响性能吗？

**A**: 会有一定影响，取决于：
- **本地代理**: 延迟增加 < 10ms，影响很小
- **远程代理**: 延迟取决于代理服务器位置和质量

### Q4: 我可以为HTTP API和Telegram客户端使用不同的代理吗？

**A**: 可以！
- **HTTP API 代理**: 通过 `internal/utils/proxy.go` 中的 `SetupProxy()` 配置（目前硬编码为开发模式）
- **Telegram 客户端代理**: 通过 `TELEGRAM_PROXY` 环境变量配置

## 安全建议

### ⚠️ 重要安全提示

1. **不要在公共仓库中提交包含代理凭据的 `fsb.env` 文件**
2. **不要使用不可信的第三方代理服务器**（可能窃取 Telegram 通信数据）
3. **建议使用本地自建代理**（Clash/V2Ray/Xray）

### 最佳实践

```bash
# .gitignore 应包含
fsb.env
*.session
*.db
```

## 测试建议

### 完整测试流程

1. **配置代理**:
   ```env
   TELEGRAM_PROXY=socks5://127.0.0.1:7890
   ```

2. **启动服务**:
   ```bash
   .\fsb.exe run --dev
   ```

3. **验证连接**:
   ```bash
   curl http://localhost:8080/upload/status -H "Authorization: Bearer your-token"
   ```

4. **测试文件上传**:
   ```bash
   curl -X POST http://localhost:8080/upload \
     -H "Authorization: Bearer your-token" \
     -F "file=@test.jpg"
   ```

## 贡献和反馈

如果您在使用代理功能时遇到问题，请：

1. 检查本文档的"常见错误"部分
2. 查看服务日志输出
3. 在 GitHub Issues 中提交详细的错误信息

---

**文档版本**: v1.0  
**最后更新**: 2025-05-08  
**适用版本**: TG-FileStreamBot v1.0.0+

