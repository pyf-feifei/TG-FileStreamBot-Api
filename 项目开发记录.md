# TG-FileStreamBot 开发记录

## 当前状态（2025-11-08）

### ✅ 已完成功能

#### 1. SOCKS5代理支持
- **配置位置**: `fsb.env` - `TELEGRAM_PROXY=socks5://127.0.0.1:7890`
- **实现文件**: `internal/utils/proxy.go`, `internal/bot/client.go`
- **作用**: 开发环境通过代理连接Telegram，解决网络限制
- **测试状态**: ✅ 通过，连接成功

#### 2. HTTP文件上传API
- **接口端点**: 
  - `POST /upload` - 单文件上传
  - `POST /upload/batch` - 批量上传
  - `GET /upload/status` - 配额查询
  - `GET /upload/metrics` - 统计查询
- **认证方式**: Bearer Token (`test-upload-token-123456789`)
- **测试状态**: ✅ 5MB视频上传成功（18秒）

#### 3. 配额管理优化
- **配置**: `USER_QUOTA=0` 或不设置 = 无限制
- **实现**: `internal/utils/upload.go` - CheckQuota() 跳过检查
- **默认值**: 改为0（不限制）
- **测试状态**: ✅ 查询返回 `"unlimited": true`

#### 4. 速率限制优化
- **当前配置**:
  ```
  UPLOADS_PER_MINUTE=15
  UPLOADS_PER_HOUR=300
  CONCURRENT_UPLOADS_PER_USER=3
  API_COOLDOWN_SECONDS=4
  ```
- **依据**: Telegram限制20条/分钟到同一频道
- **安全余量**: 5条缓冲

---

## 关键技术决策

### 1. 上传方式
- **选择**: MTProto File API (gotd/td/telegram/uploader)
- **文件大小限制**: 2GB（不是Bot API的50MB）
- **性能**: 更快的直接TCP连接

### 2. RandomID Bug修复
- **问题**: `RANDOM_ID_EMPTY` 错误
- **修复**: 在 `MessagesSendMediaRequest` 中添加 `RandomID: time.Now().UnixNano()`
- **文件**: `internal/routes/upload.go:510`

### 3. 连接超时优化
- **问题**: Telegram连接超时（10秒不够）
- **修复**: 将超时改为30秒
- **文件**: `internal/bot/client.go:48`

---

## 核心配置文件

### fsb.env（当前配置）
```bash
# Telegram配置
API_ID=25384994
API_HASH=71cd9cb338741a0a08605703edd4892e
BOT_TOKEN=7694942288:AAGGsyaglJNl2bB1M4z0iWrbycUM_SJjPVo
LOG_CHANNEL=-1002657251622

# 开发模式
DEV=true

# 上传功能
ENABLE_UPLOAD_API=true
UPLOAD_AUTH_TOKEN=test-upload-token-123456789
MAX_FILE_SIZE=209715200  # 200MB
# USER_QUOTA=0  # 不限制

# 速率限制
UPLOADS_PER_MINUTE=15
UPLOADS_PER_HOUR=300
CONCURRENT_UPLOADS_PER_USER=3
API_COOLDOWN_SECONDS=4

# 代理配置
TELEGRAM_PROXY=socks5://127.0.0.1:7890
```

---

## 待办事项

### 优先级高
- [ ] 多Token支持（实现真正的多用户）
- [ ] 持久化配额管理（数据库）
- [ ] 完善错误重试机制（FLOOD_WAIT处理）

### 优先级中
- [ ] 上传进度回调
- [ ] 批量上传优化
- [ ] 文件类型自动检测改进

### 优先级低
- [ ] Web管理界面
- [ ] 用户配额统计图表
- [ ] 日志持久化

---

## 问题记录

### 已解决
1. ✅ Telegram连接失败（context deadline exceeded）
   - 原因：超时时间太短
   - 解决：10秒 → 30秒

2. ✅ 上传失败（RANDOM_ID_EMPTY）
   - 原因：缺少必需字段
   - 解决：添加 RandomID

3. ✅ MIME类型被拒绝（application/octet-stream）
   - 原因：curl未指定类型
   - 解决：使用 `file=@xxx;type=video/mp4`

### 未解决
- 无

---

## 常用命令

### 启动服务
```bash
.\fsb.exe run --dev
```

### 测试上传
```bash
curl.exe -X POST http://localhost:8080/upload ^
  -H "Authorization: Bearer test-upload-token-123456789" ^
  -F "file=@test.mp4;type=video/mp4"
```

### 查询状态
```bash
curl.exe http://localhost:8080/upload/status ^
  -H "Authorization: Bearer test-upload-token-123456789"
```

### 重新编译
```bash
Get-Process fsb | Stop-Process -Force
go build -o fsb.exe ./cmd/fsb
```

---

## 相关文档

- 📄 `上传API使用说明.md` - API接口文档
- 📄 `代理配置说明.md` - SOCKS5代理配置
- 📄 `安全性设计说明.md` - 安全机制说明
- 📄 `工作原理说明.md` - 核心原理说明

---

**最后更新**: 2025-11-08 19:30
**状态**: 所有核心功能已完成并测试通过 ✅



