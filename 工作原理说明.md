# TG-FileStreamBot 工作原理说明

## 项目概述

TG-FileStreamBot 是一个 Telegram 文件流媒体代理服务器，它**不是**直接下载和存储文件的服务器，而是作为 Telegram API 的代理，将用户的文件请求转发给 Telegram 并实时流式传输给用户。

## 工作流程详解

### 1. 用户上传文件并获取链接

当你向 Telegram 机器人发送一个视频文件时，会发生以下过程：

1. **消息接收**: 机器人接收到你发送的媒体文件（视频、文档、图片等）
2. **消息转发**: 机器人自动将这个消息转发到一个指定的日志频道 (`LOG_CHANNEL`)
3. **生成链接**: 机器人基于文件信息（文件名、大小、类型、ID）生成一个哈希值，并创建一个访问链接
4. **返回链接**: 机器人将形如 `http://your-domain.com/stream/12345?hash=abc123` 的链接返回给你

**关键点**: 此时文件**仍然存储在 Telegram 的服务器上**，你的服务器上没有任何文件副本。

### 2. 用户访问流媒体链接

当你点击或访问返回的链接时：

1. **请求验证**: 服务器验证链接中的哈希值是否正确
2. **获取工作客户端**: 从机器人客户端池中选择一个可用的 Telegram 客户端
3. **文件定位**: 通过消息ID在日志频道中找到对应的文件
4. **流式传输**: 向 Telegram API 请求文件数据，并实时传输给你的浏览器

## 流量消耗分析

### 关于你的问题：

**Q: 访问这个连接的时候，用的流量是部署这个项目的服务器的流量吗？**

**A: 是的，但是是代理流量，不是存储流量。**

具体来说：
- 你的服务器**不存储**任何文件数据
- 当你访问视频链接时，服务器作为代理从 Telegram 服务器获取数据
- 数据流：`Telegram服务器 → 你的服务器 → 你的设备`
- 你的服务器会消耗**双向流量**：
  - 入站流量：从 Telegram 服务器获取文件数据
  - 出站流量：将文件数据传输给用户

**Q: 访问这个连接的时候视频会被下载到部署这个项目的服务器上吗？**

**A: 不会！服务器不会完整下载或存储视频文件。**

工作原理：
- 使用**流式传输**（streaming）
- 文件被分成小块（chunk，默认1MB）
- 每次只从 Telegram 获取当前需要传输的块
- 数据直接传输给用户，不在服务器上持久化存储

## 技术实现细节

### 流式传输机制

```go
// telegramReader 实现了 io.Reader 接口
// 分块从 Telegram API 读取数据
func (r *telegramReader) chunk(offset int64, limit int64) ([]byte, error) {
    req := &tg.UploadGetFileRequest{
        Offset:   offset,
        Limit:    int(limit),
        Location: r.location,
    }
    // 向 Telegram API 请求特定偏移量的数据块
    res, err := r.client.API().UploadGetFile(r.ctx, req)
    // 返回数据块，不存储到磁盘
}
```

### 内存使用

- **缓冲区**: 默认 1MB 的内存缓冲区
- **按需加载**: 只缓存当前正在传输的数据块
- **即时释放**: 数据块传输完成后立即从内存中释放

### 支持的功能

1. **断点续传**: 支持 HTTP Range 请求，可以暂停和继续下载
2. **多种媒体类型**: 支持视频、音频、文档、图片
3. **流媒体播放**: 支持在浏览器中直接播放视频/音频
4. **下载模式**: 提供 `?d=true` 参数触发文件下载

## 优势和特点

### 对用户的优势
- **节省存储空间**: 不需要在本地存储大文件
- **快速访问**: 通过直接链接快速分享文件
- **流式播放**: 无需下载完整文件即可播放视频

### 对服务器管理员的优势
- **存储成本低**: 不需要大量磁盘空间存储用户文件
- **带宽可控**: 可以通过配置限制并发连接数
- **安全性**: 文件实际上存储在 Telegram，有 Telegram 的安全保护

### 注意事项
1. **带宽消耗**: 服务器会消耗相应的带宽流量
2. **API 限制**: 受到 Telegram API 的速率限制
3. **依赖性**: 完全依赖 Telegram 的可用性
4. **合规性**: 需要遵守 Telegram 的服务条款

## 配置建议

### 多机器人支持
- 配置多个 `MULTI_TOKEN` 可以分散 API 请求负载
- 避免单个机器人触发速率限制
- 提高并发处理能力

### 服务器配置
- 建议选择带宽充足的服务器
- 配置防火墙允许必要的端口
- 考虑使用 CDN 进一步优化全球访问速度

## 部署后的使用步骤

1. **部署服务器**: 按照文档部署机器人到云服务器
2. **配置环境**: 设置 `fsb.env` 中的必要参数
3. **启动机器人**: 运行 `./fsb run` 启动服务
4. **获取链接**: 向机器人发送文件，获得流媒体链接
5. **访问内容**: 通过链接直接播放或下载文件

这个项目本质上是一个智能的 Telegram 文件代理，它巧妙地利用了 Telegram 的存储基础设施，为用户提供了便捷的文件分享和流媒体访问方案。